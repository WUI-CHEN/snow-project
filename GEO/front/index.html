<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>é“è·¯å°é–‰å»ºè­°è·¯ç·šæŸ¥è©¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="/static/css/main.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="icon" href="/static/images/ncdr.png" type="image/png">

  <style>
    /* è¨­å®š#controlså€åŸŸçš„å­—é«”é¡è‰²å’ŒèƒŒæ™¯è‰² */
    #controls {
      padding: 20px;
      background: #f0f0f0;
      color: black; /* é€™è£¡è¨­å®šå­—é«”é¡è‰²ç‚ºé»‘è‰² */
    }

    #controls input {
      padding: 5px;
      margin: 5px;
      width: 300px;
      color: black; /* æŒ‰éˆ•çš„å­—é«”é¡è‰²è¨­å®šç‚ºé»‘è‰² */
      border: 1px solid black; /* æŒ‰éˆ•é‚Šæ¡†è¨­ç‚ºé»‘è‰² */
      background-color: white; /* æŒ‰éˆ•èƒŒæ™¯è‰²è¨­ç‚ºç™½è‰² */
    }

    #controls button {
      padding: 0px 0px 8px 1px; 
      margin: 1px 10px;  
      width: 100px;
      height: 60px;
      color: black; /* æŒ‰éˆ•çš„å­—é«”é¡è‰²è¨­å®šç‚ºé»‘è‰² */
      border: 1px solid black; /* æŒ‰éˆ•é‚Šæ¡†è¨­ç‚ºé»‘è‰² */
      background-color: black; /* æŒ‰éˆ•èƒŒæ™¯è‰²è¨­ç‚ºç™½è‰² */
      font-size: 15px; /* è¨­ç½®å­—é«”å¤§å°ç‚º 18pxï¼Œèª¿æ•´ç‚ºä½ æƒ³è¦çš„å¤§å° */
      font-weight: bold; /* å¦‚æœéœ€è¦è®“å­—é«”åŠ ç²—ï¼Œå¯ä»¥åŠ é€™ä¸€è¡Œ */
    }

    #controls button:hover {
          background-color: #5a5b5d;
          color: rgb(1, 1, 1);
    }

    /* è¨­å®šå°èˆªé é¢é ­éƒ¨å­—é«”é¡è‰² */
    #header a {
      color: black; /* ä½¿å°èˆªå­—é«”é¡è‰²è®Šç‚ºé»‘è‰² */
    }

    /* å…¶ä»–é é¢æ¨£å¼ */
    #map { height: 80vh; }

    #info { 
      padding: 10px; 
      background: #fff8dc; 
      color: black;  
    }

    #info b {
      color: black;
    }

    #controls input::placeholder {
      color: rgb(200, 200, 200) !important; /* è¨­ç½® placeholder æ–‡å­—ç‚ºç°è‰² */
    }

    section.wrapper {
      padding-top: 0rem;  /* åŸæœ¬å¯èƒ½æ˜¯ 4rem */
    }

          /* å¯é¸ï¼šé€²ä¸€æ­¥è®“å…§æ–‡æ›´é è¿‘ä¸Šæ–¹ */
    .inner {
      padding-top: 1rem;
    }

    h1.major {
      margin-bottom: 3rem; /* æ¨™é¡Œèˆ‡ iframe çš„è·é›¢ */
    }

    #main.wrapper {
        margin: 0;       /* å¤–è·å…¨æ¸…ç©º */
        padding: 0.5em;  /* å…§è·èª¿å°ï¼Œè¦–éœ€æ±‚èª¿æ•´ */
    }

    #main.wrapper .inner {
        padding: 0.5em;  /* å…§è·èª¿å° */
        margin: 0;
    }

  </style>
</head>

<body class="is-preload">
  <!-- Header -->
  <header id="header">
    <a href="https://snow-project.onrender.com/" class="title">å†¬å­£ç½å®³é¢¨éšªè­¦ç¤º</a>
    <nav>
      <ul>
        <li><a href="https://snow-project.onrender.com/">Home</a></li>
        <li><a href="index.html" class="active">Map Inquiry</a></li>
      </ul>
    </nav>
  </header>

  <!-- Wrapper -->
  <div id="wrapper">
    <!-- Main -->
    <section id="main" class="wrapper">
      <div class="inner">
        <h1 class="major">é¿ç½å»ºè­°è·¯ç·šæŸ¥è©¢</h1>

        <div id="controls">    
          å‡ºç™¼åœ°ï¼š<input id="start" placeholder="å¦‚ï¼šèŠ±è“®ç«è»Šç«™">   
          ç›®çš„åœ°ï¼š<input id="end" placeholder="å¦‚ï¼šå¤ªé­¯é–£åœ‹å®¶å…¬åœ’">
          <button onclick="findRoute()">æŸ¥è©¢</button>
        </div>
        <div id="info"></div>
        <div id="map"></div>

      </div>
    </section>
  </div>

  <!-- Footer -->
  <footer id="footer" class="wrapper alt">
    <div class="inner">
      <ul class="menu">
        <li>&copy; Untitled. All rights reserved.</li>
        <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
        <li>
          Licensed under 
          <a href="http://creativecommons.org/licenses/by/3.0/" target="_blank" rel="noopener noreferrer">
            Creative Commons Attribution 3.0 Unported License
          </a>
        </li>
      </ul>
    </div>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([24.1, 121.3], 9);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const disasterPolygons = [
      [[24.182159, 121.302797], [24.112141, 121.198599], [24.083572, 121.221763], [24.153851, 121.326465]],
      [[24.187964, 120.897807], [24.146699, 120.908670], [24.179253, 121.033698],[24.220227, 121.022100]],
      [[24.688546, 121.390950], [24.651461, 121.451374],[24.630567, 121.434247], [24.668334, 121.373576]]
    ];
    disasterPolygons.forEach(p => {
      L.polygon(p, { color: 'red', fillOpacity: 0.3 }).addTo(map).bindPopup("ç½å€"); 
    });

    let routeAvoidLayer, routeNormalLayer;

    async function geocode(address) {
      const res = await fetch("http://localhost:8080/api/geocode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address })
      });
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        throw new Error("åœ°ç†ç·¨ç¢¼å›å‚³éŒ¯èª¤ï¼ˆä¸æ˜¯ JSONï¼‰ï¼š\n" + text.substring(0, 200));
      }
      if (!data.location) {
        throw new Error("âš ï¸ æ‰¾ä¸åˆ°åœ°é»ï¼Œè«‹ç¢ºèªåœ°å€æ­£ç¢ºï¼");
      }
      return data.location;
    }



    async function findRoute() {
      const start = document.getElementById("start").value.trim();
      const end = document.getElementById("end").value.trim();
      if (!start || !end) return alert("è«‹è¼¸å…¥èµ·é»èˆ‡çµ‚é»");

      if (routeAvoidLayer) map.removeLayer(routeAvoidLayer);
      if (routeNormalLayer) map.removeLayer(routeNormalLayer);

      try {
        const [startLoc, endLoc] = await Promise.all([geocode(start), geocode(end)]);

        const [avoidRes, normalRes] = await Promise.all([
          fetch("http://localhost:8080/api/route", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              stops: [startLoc, endLoc],
              barriers: disasterPolygons.map(poly => poly.map(([lat, lng]) => [lng, lat]))
            })
          }),
          fetch("http://localhost:8080/api/route", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ stops: [startLoc, endLoc] })
          })
        ]);

        const avoidText = await avoidRes.text();
        let avoidData = JSON.parse(avoidText);

        const normalText = await normalRes.text();
        let normalData = JSON.parse(normalText);

        if (!avoidData.routes.features.length) {
          alert("é¿ç½è·¯ç·šæŸ¥ç„¡çµæœ");
          return;
        }
        const avoidPath = avoidData.routes.features[0].geometry.paths[0].map(p => [p[1], p[0]]);

        if (!normalData.routes.features.length) {
          alert("æœ€çŸ­è·¯ç·šæŸ¥ç„¡çµæœ");
          return;
        }
        const normalPath = normalData.routes.features[0].geometry.paths[0].map(p => [p[1], p[0]]);

        routeAvoidLayer = L.polyline(avoidPath, { color: "blue", weight: 5 }).addTo(map).bindPopup("é¿é–‹ç½å€");
        routeNormalLayer = L.polyline(normalPath, { color: "red", dashArray: "5,5" }).addTo(map).bindPopup("æœ€çŸ­è·¯ç·š");

        map.fitBounds(routeAvoidLayer.getBounds());

        const a = avoidData.routes.features[0].attributes;
        const n = normalData.routes.features[0].attributes;

        let extraInfo = `
          ğŸ”µ <b>é¿ç½è·¯ç·š</b>ï¼š${a.Total_Kilometers.toFixed(1)} km / ${a.Total_TravelTime.toFixed(1)} åˆ†<br>
          ğŸ”´ <b>æœ€çŸ­è·¯ç·š</b>ï¼š${n.Total_Kilometers.toFixed(1)} km / ${n.Total_TravelTime.toFixed(1)} åˆ†<br>
          â• å¤šå‡ºï¼š${(a.Total_Kilometers - n.Total_Kilometers).toFixed(1)} km / ${(a.Total_TravelTime - n.Total_TravelTime).toFixed(1)} åˆ†
        `;

        // åŠ å…¥åˆ¤æ–·ï¼Œè‹¥æœ€çŸ­è·¯ç·šæ¯”é¿ç½è·¯ç·šé•·ï¼Œé¡¯ç¤ºè­¦å‘Šè¨Šæ¯
        if (n.Total_Kilometers > a.Total_Kilometers) {
          extraInfo += `
            <br><b>âš ï¸è­¦å‘Šï¼š</b>å‡ºç™¼åœ°æˆ–ç›®çš„åœ°å¯èƒ½ä½æ–¼çµå†°é«˜é¢¨éšªå€åŸŸï¼Œè«‹ä¾è·¯æ³èª¿æ•´è·¯ç·šï¼Œå°å¿ƒé§•é§›ã€‚
          `;
        }

        document.getElementById("info").innerHTML = extraInfo;

      } catch (err) {
        alert("æŸ¥è©¢éŒ¯èª¤ï¼š" + err.message);
      }
    }

  </script>
</body>
</html>
